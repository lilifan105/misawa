# RAG検索機能 実装完了サマリー

## 実装日
2025年1月

## 実装概要

Amazon Bedrock Knowledge BaseとS3 Vectorsを使用したRAG（Retrieval Augmented Generation）全文検索機能を実装しました。

## 実装内容

### 1. バックエンド

#### Lambda関数（search/lambda_function.py）
- Bedrock Agent Runtime APIを使用したベクトル検索
- Knowledge Base Retrieve APIの統合
- 検索結果の整形とメタデータ処理
- エラーハンドリング

**主要機能:**
- クエリ検証
- ベクトル検索実行
- 文書IDの抽出
- ページ番号等のメタデータ取得

**環境変数:**
- `KNOWLEDGE_BASE_ID`: Bedrock Knowledge BaseのID

**IAM権限:**
- `bedrock:Retrieve`
- `bedrock:RetrieveAndGenerate`

### 2. フロントエンド

#### 検索画面（rag-search-page.tsx）
- 検索クエリ入力UI
- リアルタイム検索実行
- 検索結果カード表示
- 関連度スコア表示
- ページ番号付き文書プレビューリンク

**UI特徴:**
- 現在のUIスタイルと統一
- レスポンシブデザイン
- ローディング状態表示
- 空状態ハンドリング

#### API統合（lib/api.ts）
- `searchDocuments()` 関数追加
- エラーハンドリング
- TypeScript型定義

#### ナビゲーション
- ヘッダーに「全文検索」ボタン追加
- `/search` ルート作成
- 文書閲覧画面でページ番号パラメータ対応

### 3. インフラ（Terraform）

#### Bedrock Module
- S3 Vector Bucket作成
- Bedrock Knowledge Base作成
- Bedrock Data Source作成
- IAMロールとポリシー設定

#### Compute Module
- Lambda関数にKNOWLEDGE_BASE_ID環境変数追加
- IAMポリシーにBedrock権限追加
- 変数定義追加

**新規ファイル:**
- `modules/bedrock/main.tf`
- `modules/bedrock/variables.tf`
- `modules/bedrock/outputs.tf`
- `modules/bedrock/README.md`

**変更ファイル:**
- `modules/compute/main.tf`
- `modules/compute/variables.tf`
- `main.tf`
- `outputs.tf`

## アーキテクチャ

```
ユーザー → Next.js → API Gateway → Lambda → Bedrock KB → S3 Vectors
                                                        ↓
                                                   S3 Bucket
```

## セットアップ手順

### 前提条件
1. S3バケットに文書をアップロード
2. Bedrock Knowledge Baseを作成
3. S3 Vectorsをベクトルストアとして設定
4. データソースの同期（Ingestion）

### デプロイ手順
1. Lambda関数をビルド: `.\build_and_package.ps1`
2. Terraformでデプロイ: `terraform apply`
3. Knowledge Base IDを確認: `terraform output knowledge_base_id`
4. 文書をS3にアップロード
5. データソースを同期: `aws bedrock-agent start-ingestion-job`
6. フロントエンド起動: `npm run dev`

## 動作確認

### テスト項目
- [x] 検索画面へのアクセス（/search）
- [x] 検索クエリの入力
- [x] 検索結果の表示
- [x] 関連度スコアの表示
- [x] 文書カードのクリック
- [x] 該当ページへの遷移

### 確認コマンド
```bash
# Lambda環境変数確認
aws lambda get-function-configuration \
  --function-name misawa-search-dev \
  --query 'Environment.Variables.KNOWLEDGE_BASE_ID'

# Knowledge Base確認
aws bedrock-agent list-knowledge-bases

# データソース同期状態確認
aws bedrock-agent list-ingestion-jobs \
  --knowledge-base-id YOUR_KB_ID \
  --data-source-id YOUR_DS_ID
```

## ファイル一覧

### 新規作成
- `backend/functions/search/lambda_function.py` (更新)
- `frontend/components/rag-search-page.tsx`
- `frontend/app/search/page.tsx`
- `frontend/lib/api.ts` (更新)
- `infrastructure/modules/bedrock/main.tf`
- `infrastructure/modules/bedrock/variables.tf`
- `infrastructure/modules/bedrock/outputs.tf`
- `infrastructure/modules/bedrock/README.md`
- `docs/04_実装/RAG検索機能/RAG検索機能実装ガイド.md`
- `docs/04_実装/RAG検索機能/RAG検索機能実装ガイド/architecture.puml`
- `docs/04_実装/RAG検索機能/RAG検索機能実装ガイド/sequence.puml`
- `docs/04_実装/RAG検索機能/RAG検索機能実装ガイド/data-flow.puml`

### 更新
- `frontend/components/system-header.tsx`
- `frontend/components/document-viewer-page.tsx`
- `frontend/app/view/[id]/page.tsx`
- `infrastructure/modules/compute/main.tf`
- `infrastructure/modules/compute/variables.tf`
- `infrastructure/main.tf`
- `infrastructure/outputs.tf`
- `README.md`

## コスト見積もり

### 追加コスト（月額）
- S3 Vectors: $0.23（10GBベクトル）
- Bedrock Knowledge Base: $0.30（10万クエリ）
- **合計追加コスト: $0.53/月**

### 総コスト
- 既存システム: $46.00/月
- RAG検索追加後: $46.53/月

## 今後の拡張予定

### 短期
1. メタデータフィルタリング機能
2. 検索結果のページネーション
3. 検索履歴機能

### 中期
1. ハイブリッド検索（キーワード + ベクトル）
2. Bedrock Rerankingによる精度向上
3. マルチモーダル検索（画像対応）

### 長期
1. RetrieveAndGenerate APIによる要約生成
2. チャットボット統合
3. 検索分析ダッシュボード

## トラブルシューティング

### よくある問題

**問題1: 検索結果が返らない**
- Knowledge Baseの同期状態を確認
- KNOWLEDGE_BASE_ID環境変数を確認
- IAM権限を確認

**問題2: "AccessDeniedException"**
- Lambda実行ロールにBedrock権限を追加
- Knowledge BaseのリソースポリシーでLambdaロールを許可

**問題3: ページ番号が表示されない**
- メタデータファイル（.metadata.json）を確認
- データソースを再同期

## 参考資料

- [RAG検索機能実装ガイド](./RAG検索機能実装ガイド.md)
- [Amazon Bedrock Knowledge Bases](https://docs.aws.amazon.com/bedrock/latest/userguide/knowledge-base.html)
- [S3 Vectors Documentation](https://docs.aws.amazon.com/AmazonS3/latest/userguide/s3-vectors.html)
- [Bedrock Retrieve API](https://docs.aws.amazon.com/bedrock/latest/APIReference/API_agent-runtime_Retrieve.html)

## 実装者メモ

### 技術的な決定事項
1. **S3 Vectorsを選択した理由**
   - コスト効率（OpenSearchより90%削減）
   - 管理不要（フルマネージド）
   - Bedrockとのネイティブ統合

2. **埋め込みモデル**
   - Titan Embed Text v2を選択
   - 1024次元ベクトル
   - 多言語対応

3. **チャンキング戦略**
   - デフォルト戦略を使用
   - 将来的にセマンティックチャンキングを検討

### 既知の制限事項
1. S3 Vectorsはセマンティック検索のみ（キーワード検索不可）
2. ベクトルインデックスサイズの上限あり
3. 浮動小数点ベクトルのみサポート

## 完了チェックリスト

- [x] バックエンド実装
- [x] フロントエンド実装
- [x] インフラ設定（Terraformモジュール完全実装）
- [x] ドキュメント作成
- [x] PlantUML図作成
- [x] README更新
- [x] 動作確認手順作成
- [x] トラブルシューティングガイド作成
