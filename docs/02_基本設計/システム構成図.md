# 文書管理システム - システム構成図

## 1. 全体アーキテクチャ

```
┌─────────────────────────────────────────────────────────────────┐
│                        クライアント層                              │
├─────────────────────────────────────────────────────────────────┤
│  ・Webブラウザ (React SPA)                                        │
│  ・Google Cloud Platform (外部システム)                           │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 │ HTTPS
                 ↓
┌─────────────────────────────────────────────────────────────────┐
│                    AWS Amplify Hosting                           │
├─────────────────────────────────────────────────────────────────┤
│  ・静的コンテンツ配信 (React SPA)                                 │
│  ・CI/CD パイプライン                                             │
│  ・カスタムドメイン & SSL証明書                                   │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 │ HTTPS
                 ↓
┌─────────────────────────────────────────────────────────────────┐
│                    Amazon CloudFront (CDN)                       │
├─────────────────────────────────────────────────────────────────┤
│  ・グローバルコンテンツ配信                                        │
│  ・キャッシング                                                   │
└────────────────┬────────────────────────────────────────────────┘
                 │
                 │
    ┌────────────┴────────────┐
    │                         │
    ↓                         ↓
┌─────────────────┐   ┌─────────────────────────────────────┐
│  Amazon Cognito │   │      Amazon API Gateway              │
├─────────────────┤   ├─────────────────────────────────────┤
│ ・ユーザー認証   │   │ ・REST API エンドポイント            │
│ ・ユーザープール │   │ ・認証・認可 (Cognito連携)           │
│ ・グループ管理   │   │ ・レート制限                         │
│ ・権限管理       │   │ ・API キー管理 (外部連携用)          │
└─────────────────┘   └──────────┬──────────────────────────┘
                                 │
                                 │
        ┌────────────────────────┼────────────────────────┐
        │                        │                        │
        ↓                        ↓                        ↓
┌──────────────────┐   ┌──────────────────┐   ┌──────────────────┐
│  AWS Lambda      │   │  AWS Lambda      │   │  AWS Lambda      │
│  (文書管理)       │   │  (検索・RAG)      │   │  (外部API)        │
├──────────────────┤   ├──────────────────┤   ├──────────────────┤
│・文書CRUD        │   │・全文検索         │   │・GCP連携API      │
│・承認ワークフロー │   │・RAG処理         │   │・文書一覧取得     │
│・権限チェック     │   │・ベクトル検索     │   │・権限フィルタ     │
└────────┬─────────┘   └────────┬─────────┘   └────────┬─────────┘
         │                      │                      │
         │                      │                      │
    ┌────┴──────────────────────┴──────────────────────┴────┐
    │                                                        │
    ↓                                                        ↓
┌─────────────────────────────────────┐   ┌──────────────────────────┐
│         Amazon DynamoDB              │   │  Amazon OpenSearch       │
├─────────────────────────────────────┤   │  Service                 │
│ ・文書マスタテーブル                  │   ├──────────────────────────┤
│ ・添付ファイルテーブル                │   │ ・文書全文インデックス    │
│ ・ユーザーマスタテーブル              │   │ ・ベクトルインデックス    │
│ ・承認履歴テーブル                    │   │ ・権限情報インデックス    │
│ ・閲覧履歴テーブル                    │   │ ・RAG用埋め込みデータ     │
│ ・文書版管理テーブル                  │   └──────────────────────────┘
│ ・GSI: 発番部署別、カテゴリ別         │
└─────────────────────────────────────┘
         │
         │
         ↓
┌─────────────────────────────────────┐
│           Amazon S3                  │
├─────────────────────────────────────┤
│ ・PDFファイル保存                     │
│ ・バージョニング有効化                │
│ ・ライフサイクルポリシー              │
│ ・暗号化 (SSE-S3)                    │
└─────────────────────────────────────┘
         │
         │
         ↓
┌─────────────────────────────────────┐
│      AWS Lambda (非同期処理)         │
├─────────────────────────────────────┤
│ ・S3イベントトリガー                  │
│ ・PDF→テキスト抽出                   │
│ ・OpenSearch インデックス登録         │
│ ・ベクトル埋め込み生成                │
└─────────────────────────────────────┘
         │
         │
         ↓
┌─────────────────────────────────────┐
│      Amazon Bedrock                  │
├─────────────────────────────────────┤
│ ・テキスト埋め込み生成                │
│ ・RAG用LLMモデル                     │
│ ・Claude / Titan Embeddings          │
└─────────────────────────────────────┘


┌─────────────────────────────────────┐
│         監視・ログ・通知              │
├─────────────────────────────────────┤
│ ・Amazon CloudWatch Logs             │
│ ・Amazon CloudWatch Metrics          │
│ ・AWS X-Ray (分散トレーシング)        │
│ ・Amazon SNS (通知)                  │
│ ・Amazon SES (メール送信)            │
└─────────────────────────────────────┘
```

---

## 2. データフロー

### 2.1 文書登録フロー
```
1. ユーザー → Amplify → API Gateway → Lambda (文書管理)
2. Lambda → DynamoDB (文書メタデータ保存)
3. Lambda → S3 (PDFファイル保存)
4. S3イベント → Lambda (非同期処理)
5. Lambda → Bedrock (テキスト埋め込み生成)
6. Lambda → OpenSearch (インデックス登録)
```

### 2.2 文書検索フロー (RAG)
```
1. ユーザー → Amplify → API Gateway → Lambda (検索・RAG)
2. Lambda → Bedrock (クエリ埋め込み生成)
3. Lambda → OpenSearch (ベクトル検索 + 権限フィルタ)
4. Lambda → DynamoDB (文書メタデータ取得)
5. Lambda → Bedrock (RAG応答生成)
6. Lambda → ユーザー (検索結果 + AI要約)
```

### 2.3 外部API連携フロー (GCP)
```
1. GCPシステム → API Gateway (APIキー認証)
2. API Gateway → Lambda (外部API)
3. Lambda → Cognito (権限確認)
4. Lambda → DynamoDB (文書一覧取得 + 権限フィルタ)
5. Lambda → GCPシステム (JSON応答)
```

---

## 3. AWSサービス一覧

| サービス | 用途 | 備考 |
|---------|------|------|
| AWS Amplify | フロントエンドホスティング、CI/CD | React SPA配信 |
| Amazon CloudFront | CDN | グローバル配信 |
| Amazon Cognito | 認証・認可 | ユーザープール、グループ管理 |
| Amazon API Gateway | REST API | 内部・外部API |
| AWS Lambda | サーバーレス処理 | Node.js/Python |
| Amazon DynamoDB | NoSQLデータベース | 文書メタデータ |
| Amazon S3 | オブジェクトストレージ | PDFファイル保存 |
| Amazon OpenSearch Service | 全文検索・ベクトル検索 | RAG対応 |
| Amazon Bedrock | 生成AI | 埋め込み生成、RAG |
| Amazon CloudWatch | 監視・ログ | メトリクス、ログ |
| AWS X-Ray | 分散トレーシング | パフォーマンス監視 |
| Amazon SNS | 通知 | アラート通知 |
| Amazon SES | メール送信 | 承認通知等 |
| AWS IAM | アクセス管理 | 権限管理 |
| AWS Secrets Manager | シークレット管理 | APIキー等 |

---

## 4. セキュリティ設計

### 4.1 認証・認可
- **Cognito User Pool**: ユーザー認証
- **Cognitoグループ**: 役割ベースアクセス制御 (閲覧者、投稿者、承認者、管理者)
- **API Gateway Authorizer**: JWT検証
- **APIキー**: 外部システム連携用

### 4.2 データ保護
- **S3暗号化**: SSE-S3 (サーバーサイド暗号化)
- **DynamoDB暗号化**: 保管時暗号化
- **通信暗号化**: HTTPS/TLS 1.2以上
- **Secrets Manager**: 機密情報管理

### 4.3 アクセス制御
- **IAMロール**: 最小権限の原則
- **VPC**: OpenSearchをVPC内配置
- **セキュリティグループ**: Lambda→OpenSearch通信制限
- **S3バケットポリシー**: プライベートアクセスのみ

---

## 5. スケーラビリティ・可用性

### 5.1 スケーラビリティ
- **Lambda**: 自動スケーリング
- **DynamoDB**: オンデマンドキャパシティ
- **OpenSearch**: マルチAZ配置、自動スケーリング
- **CloudFront**: グローバルエッジロケーション

### 5.2 可用性
- **マルチAZ構成**: DynamoDB、OpenSearch
- **S3**: 99.999999999% (11 9's) 耐久性
- **CloudFront**: 自動フェイルオーバー
- **Lambda**: 複数AZ自動配置

---

## 6. コスト最適化

### 6.1 コスト削減策
- **S3ライフサイクルポリシー**: 古いバージョンをGlacierへ移行
- **DynamoDB**: オンデマンドモード (低トラフィック時)
- **Lambda**: メモリ最適化、実行時間短縮
- **CloudWatch Logs**: ログ保持期間設定 (30日)
- **OpenSearch**: 適切なインスタンスサイズ選定

### 6.2 コスト監視
- **AWS Cost Explorer**: コスト分析
- **AWS Budgets**: 予算アラート
- **CloudWatch Billing Alarms**: 閾値アラート

---

## 7. 外部連携仕様 (GCP)

### 7.1 API仕様
- **エンドポイント**: `https://api.example.com/external/documents`
- **認証方式**: APIキー (ヘッダー: `X-API-Key`)
- **レスポンス形式**: JSON
- **権限フィルタ**: GCPシステムのユーザーIDに基づく文書一覧

### 7.2 セキュリティ
- **APIキー管理**: Secrets Managerで管理
- **レート制限**: API Gateway (1000 req/min)
- **IPホワイトリスト**: 必要に応じて設定
- **監査ログ**: CloudWatch Logsに記録

---

## 8. RAG (Retrieval-Augmented Generation) 設計

### 8.1 RAGフロー
```
1. ユーザークエリ → Bedrock (埋め込み生成)
2. ベクトル検索 → OpenSearch (類似文書取得)
3. 権限フィルタ → ユーザーが閲覧可能な文書のみ
4. コンテキスト生成 → 検索結果をプロンプトに追加
5. LLM生成 → Bedrock (Claude) で回答生成
6. 応答返却 → ユーザーに表示
```

### 8.2 権限管理
- **OpenSearchクエリ**: ユーザーの所属部署・グループでフィルタ
- **DynamoDB参照**: 文書の公開範囲と照合
- **Lambda処理**: 権限チェックロジック実装

### 8.3 インデックス構造
```json
{
  "document_id": "25001",
  "title": "文書タイトル",
  "content": "抽出されたテキスト",
  "embedding": [0.123, 0.456, ...],
  "category": "通達",
  "publish_date": "2025-04-01",
  "permissions": {
    "departments": ["総務部", "人事部"],
    "groups": ["管理職"]
  }
}
```

---

## 9. 開発・運用環境

### 9.1 環境分離
- **開発環境 (dev)**: 開発・テスト用
- **本番環境 (prod)**: 本番運用

### 9.2 CI/CD
- **Amplify CI/CD**: Gitプッシュで自動デプロイ
- **Lambda**: AWS SAM / Serverless Framework
- **IaC**: AWS CDK / Terraform

### 9.3 監視・アラート
- **CloudWatch Dashboards**: システム全体の可視化
- **CloudWatch Alarms**: エラー率、レイテンシ監視
- **SNS通知**: Slack/Email連携

---

## 10. 技術スタック

### 10.1 フロントエンド
- **フレームワーク**: React 18+
- **状態管理**: React Context / Zustand
- **UIライブラリ**: Material-UI / Ant Design
- **認証**: AWS Amplify Auth
- **API通信**: AWS Amplify API / Axios

### 10.2 バックエンド
- **ランタイム**: Node.js 20.x / Python 3.12
- **フレームワーク**: Express (Lambda) / FastAPI
- **ORM**: DynamoDB DocumentClient
- **PDF処理**: pdf-parse / PyPDF2

### 10.3 インフラ
- **IaC**: AWS CDK (TypeScript)
- **バージョン管理**: Git (GitHub/GitLab)
- **CI/CD**: AWS Amplify + GitHub Actions

---

## 11. 非機能要件対応

| 要件 | 対応方法 |
|------|---------|
| 性能 | Lambda同時実行数制御、DynamoDB GSI、CloudFrontキャッシング |
| セキュリティ | Cognito認証、IAM最小権限、暗号化、WAF (必要時) |
| 可用性 | マルチAZ、自動スケーリング、ヘルスチェック |
| 保守性 | CloudWatch Logs、X-Ray、構造化ログ |
| 拡張性 | サーバーレスアーキテクチャ、マイクロサービス設計 |

---

## 12. 今後の拡張性

### 12.1 機能拡張
- **モバイルアプリ**: React Native + Amplify
- **リアルタイム通知**: AppSync (GraphQL) + WebSocket
- **OCR機能**: Amazon Textract
- **音声検索**: Amazon Transcribe

### 12.2 グローバル展開
- **マルチリージョン**: DynamoDB Global Tables
- **CloudFront**: グローバルエッジロケーション
- **多言語対応**: i18n対応

